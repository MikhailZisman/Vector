



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Kotlin Coroutines based MVI Architecture Library">
      
      
        <link rel="canonical" href="https://haroldadmin.github.io/vector/advanced-usage/">
      
      
        <meta name="author" content="Kshitij Chauhan">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../images/logo-monochrome.svg">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.2">
    
    
      
        <title>Advanced - Vector</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.30686662.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.a8b3c06d.css">
      
      
        
        
        <meta name="theme-color" content="#009688">
      
    
    
      <script src="../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
    
    
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="teal" data-md-color-accent="blue">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#advanced-usage" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://haroldadmin.github.io/vector/" title="Vector" class="md-header-nav__button md-logo">
          
            <img src="../images/logo-monochrome.svg" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Vector
            </span>
            <span class="md-header-nav__topic">
              
                Advanced
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/haroldadmin/Vector/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Vector
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://haroldadmin.github.io/vector/" title="Vector" class="md-nav__button md-logo">
      
        <img src="../images/logo-monochrome.svg" width="48" height="48">
      
    </a>
    Vector
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/haroldadmin/Vector/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    Vector
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../introduction/" title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Usage
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Usage
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../usage/" title="Simple" class="md-nav__link">
      Simple
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Advanced
      </label>
    
    <a href="./" title="Advanced" class="md-nav__link md-nav__link--active">
      Advanced
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependency-injection-support" class="md-nav__link">
    Dependency Injection support
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#koin" class="md-nav__link">
    Koin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dagger-and-assistedinject" class="md-nav__link">
    Dagger and AssistedInject
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-process-death" class="md-nav__link">
    Handling process death
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#whats-process-death" class="md-nav__link">
    What's process death?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#doesnt-a-viewmodel-handle-this-automatically" class="md-nav__link">
    Doesn't a ViewModel handle this automatically?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problems-with-onsaveinstancestate" class="md-nav__link">
    Problems with onSaveInstanceState
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vectors-solution" class="md-nav__link">
    Vector's solution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#persisting-state" class="md-nav__link">
    Persisting state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restoring-state" class="md-nav__link">
    Restoring state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Components
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Components
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../vector-state/" title="Vector State" class="md-nav__link">
      Vector State
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vector-fragment/" title="Vector Fragment" class="md-nav__link">
      Vector Fragment
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../vector-viewmodel/" title="Vector ViewModel" class="md-nav__link">
      Vector ViewModel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../saved-state-vectorviewmodel/" title="SavedState VectorViewModel" class="md-nav__link">
      SavedState VectorViewModel
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../logging/" title="Logging" class="md-nav__link">
      Logging
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Advanced
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Advanced
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../automatic-viewmodel-creation/" title="Automatic ViewModel Creation" class="md-nav__link">
      Automatic ViewModel Creation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../state-store-context/" title="Coroutine Context for State Store" class="md-nav__link">
      Coroutine Context for State Store
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../api/vector/" title="API Reference" class="md-nav__link">
      API Reference
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dependency-injection-support" class="md-nav__link">
    Dependency Injection support
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#koin" class="md-nav__link">
    Koin
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dagger-and-assistedinject" class="md-nav__link">
    Dagger and AssistedInject
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handling-process-death" class="md-nav__link">
    Handling process death
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#whats-process-death" class="md-nav__link">
    What's process death?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#doesnt-a-viewmodel-handle-this-automatically" class="md-nav__link">
    Doesn't a ViewModel handle this automatically?
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#problems-with-onsaveinstancestate" class="md-nav__link">
    Problems with onSaveInstanceState
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#vectors-solution" class="md-nav__link">
    Vector's solution
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#persisting-state" class="md-nav__link">
    Persisting state
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#restoring-state" class="md-nav__link">
    Restoring state
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/haroldadmin/Vector/edit/master/docs/advanced-usage.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="advanced-usage">Advanced Usage<a class="headerlink" href="#advanced-usage" title="Permanent link">&para;</a></h1>
<p>Let us continue with the example described in the <a href="../usage/">Usage</a> page.</p>
<h2 id="dependency-injection-support">Dependency Injection support<a class="headerlink" href="#dependency-injection-support" title="Permanent link">&para;</a></h2>
<p>Our ViewModel needs access to a Repository or a Use-Case class in order to be able to fetch the user's notes. In the <a href="../usage/">Usage</a> section, we setup the repository as a singleton Kotlin <code>object</code>, so that we could access it without creating an instance of it.</p>
<p>This is rarely the case in real applications, and it is much more common to split your business logic into different Use-Case classes. Let us create a <code>GetNotesUseCase</code> class for our notes app:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">GetNotesUseCase</span> <span class="p">(</span><span class="k">private</span> <span class="k">val</span> <span class="py">repository</span><span class="p">:</span> <span class="n">NotesRepository</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">fun</span> <span class="nf">getAllNotes</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="k">fun</span> <span class="nf">getPinnedNotes</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="k">fun</span> <span class="nf">getArchivedNotes</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Our ViewModel now looks like this:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">NotesListViewModel</span><span class="p">(</span>
  <span class="n">initialState</span><span class="p">:</span> <span class="n">NotesListState</span><span class="p">,</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">notesUseCase</span><span class="p">:</span> <span class="n">GetNotesUseCase</span>
<span class="p">):</span> <span class="n">VectorViewModel</span><span class="p">&lt;</span><span class="n">NotesListState</span><span class="p">&gt;(</span><span class="n">initialState</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>

  <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getNotes</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>

  <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getAllNotes</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">allNotes</span> <span class="p">=</span> <span class="n">notesUseCase</span><span class="p">.</span><span class="n">getAllNotes</span><span class="p">()</span>
    <span class="n">setState</span> <span class="p">{</span> <span class="n">copy</span><span class="p">(</span><span class="n">notes</span> <span class="p">=</span> <span class="n">allNotes</span><span class="p">)</span> <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getPinnedNotes</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
  <span class="n">suspend</span> <span class="k">fun</span> <span class="nf">getArchivedNotes</span><span class="p">()</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Due to the addition of an additional dependency in the constructor which Vector can not satisfy <em>on its own</em>, we can not instantiate this ViewModel in our Fragment or Activity in the way we did before.</p>
<p>We need to tell Vector how to satisfy this ViewModel's dependencies using a <code>VectorViewModelFactory</code>, implemented in this ViewModel's <code>companion object</code>.</p>
<p>The <code>VectorViewModelFactory</code> interface has a method named <code>create()</code>, which is used to create and return an instance of this ViewModel. The <code>create()</code> method is supplied with a <code>ViewModelOwner</code> parameter, which is a wrapper around the Fragment/Activity owning this ViewModel. It can be used to get access to your dependency injection library's object graph. <strong>You must not store a reference to this owner in your ViewModel, or you will create a memory leak for your Activity or Fragment.</strong></p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">NotesListViewModel</span><span class="p">(</span>
  <span class="n">initialState</span><span class="p">:</span> <span class="n">NotesListState</span><span class="p">,</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">notesUseCase</span><span class="p">:</span> <span class="n">GetNotesUseCase</span>
<span class="p">):</span> <span class="n">VectorViewModel</span><span class="p">&lt;</span><span class="n">NotesListState</span><span class="p">&gt;(</span><span class="n">initialState</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">...</span>

  <span class="k">companion</span> <span class="k">object</span><span class="p">:</span> <span class="n">VectorViewModelFactory</span><span class="p">&lt;</span><span class="n">NotesListViewModel</span><span class="p">,</span> <span class="n">NotesListState</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">create</span><span class="p">(</span><span class="n">initialState</span><span class="p">:</span> <span class="n">NotesListState</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">ViewModelOwner</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">):</span> <span class="n">NotesListViewModel</span><span class="p">?</span> <span class="p">{</span> 
      <span class="k">val</span> <span class="py">usecase</span> <span class="p">=</span> <span class="c1">// use the ViewModelOwner parameter to access DI graph and get GetNotesUseCase</span>
      <span class="k">return</span> <span class="n">NotesListViewmodel</span><span class="p">(</span><span class="n">initialState</span><span class="p">,</span> <span class="n">usecase</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>With this factory now implemented, we can get access to our ViewModel again using view model delegates such as <code>by fragmentViewModel()</code>. Vector will lookup the factory automatically, and use it to instantiate your ViewModel.</p>
<h3 id="koin">Koin<a class="headerlink" href="#koin" title="Permanent link">&para;</a></h3>
<p>If you are using <a href="https://insert-koin.io">Koin</a>, the <code>create()</code> method in a <code>VectorViewModelFactory</code> looks like this:</p>
<div class="codehilite"><pre><span></span><span class="k">fun</span> <span class="nf">create</span><span class="p">(</span><span class="n">initialState</span><span class="p">:</span> <span class="n">NotesListState</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">ViewModelOwner</span><span class="p">,</span> <span class="n">handle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">):</span> <span class="n">NotesListViewModel</span><span class="p">?</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">usecase</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">owner</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">is</span> <span class="n">FragmentViewModelOwner</span> <span class="p">-&gt;</span> <span class="n">owner</span><span class="p">.</span><span class="n">fragment</span><span class="p">.</span><span class="k">get</span><span class="p">&lt;</span><span class="n">GetNotesUseCase</span><span class="p">&gt;()</span> <span class="c1">// `get` extension method from Koin</span>
    <span class="k">is</span> <span class="n">ActivityViewModelOwner</span> <span class="p">-&gt;</span> <span class="n">owner</span><span class="p">.</span><span class="n">activity</span><span class="p">.</span><span class="k">get</span><span class="p">&lt;</span><span class="n">GetNotesUseCase</span><span class="p">&gt;()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">NotesListViewmodel</span><span class="p">(</span><span class="n">initialState</span><span class="p">,</span> <span class="n">usecase</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h3 id="dagger-and-assistedinject">Dagger and AssistedInject<a class="headerlink" href="#dagger-and-assistedinject" title="Permanent link">&para;</a></h3>
<p><a href="https://github.com/google/dagger">Dagger</a> can generate your DI graph at compile time, but it can not handle constructor paramters only available at run-time such as the <code>initialState</code> parameter in our ViewModel. The <a href="https://github.com/square/AssistedInject">AssistedInject</a> library helps with this, as it automatically generates factories for classes which depend on such runtime parameters.</p>
<p>Usage of AssistedInject and Dagger in Vector looks like this:</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">NotesListViewModel</span> <span class="n">@AssistedInject</span> <span class="k">constructor</span><span class="p">(</span>
  <span class="n">@Assisted</span> <span class="n">initialState</span><span class="p">:</span> <span class="n">NotesListState</span><span class="p">,</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">usecase</span><span class="p">:</span> <span class="n">GetNotesUseCase</span>
<span class="p">)</span> <span class="p">{</span>

  <span class="p">...</span>

  <span class="n">@AssistedInject</span><span class="p">.</span><span class="n">Factory</span>
  <span class="k">interface</span> <span class="nc">Factory</span> <span class="p">{</span>
    <span class="k">fun</span> <span class="nf">create</span><span class="p">(</span><span class="n">initialState</span><span class="p">:</span> <span class="n">NotesListState</span><span class="p">):</span> <span class="n">NotesListViewModel</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">NotesListFragment</span><span class="p">:</span> <span class="n">VectorFragment</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">@Inject</span>
  <span class="k">lateinit</span> <span class="k">var</span> <span class="py">viewModelFactory</span><span class="p">:</span> <span class="n">NotesListViewModel</span><span class="p">.</span><span class="n">Factory</span>

  <span class="k">private</span> <span class="k">val</span> <span class="py">viewModel</span><span class="p">:</span> <span class="n">NotesListViewModel</span> <span class="k">by</span> <span class="n">fragmentViewModel</span> <span class="p">{</span> <span class="n">initialState</span><span class="p">,</span> <span class="n">savedStateHandle</span> <span class="p">-&gt;</span>
    <span class="n">viewModelFactory</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">initialState</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">override</span> <span class="k">fun</span> <span class="nf">onCreate</span><span class="p">(...)</span> <span class="p">{</span>
    <span class="n">inject</span><span class="p">()</span>
    <span class="k">super</span><span class="p">.</span><span class="n">onCreate</span><span class="p">(...)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>We leverage another ViewModel delegate supplied by Vector which accepts a ViewModel producing lambda as an input. When this lambda is supplied, you don't need to implement the <code>VectorViewModelFactory</code> interface just to create your ViewModel with custom dependencies.</p>
<h2 id="handling-process-death">Handling process death<a class="headerlink" href="#handling-process-death" title="Permanent link">&para;</a></h2>
<h3 id="whats-process-death">What's process death?<a class="headerlink" href="#whats-process-death" title="Permanent link">&para;</a></h3>
<p>When Android kills your application process while it is in the background, we call it process death. Before your application is killed, <code>onSaveInstanceState</code> is called for your Activities/Fragments, which can persist their state in a Bundle. When your application is recreated after a Process Death, you receive this bundle back as an argument as <code>savedInstanceState</code> in the <code>onCreate()</code> method.</p>
<h3 id="doesnt-a-viewmodel-handle-this-automatically">Doesn't a ViewModel handle this automatically?<a class="headerlink" href="#doesnt-a-viewmodel-handle-this-automatically" title="Permanent link">&para;</a></h3>
<p>No, a ViewModel is built to handle configuration changes, such as rotations or locale changes. It does not survive process death. Any state held by the ViewModel is lost after a process death, and is not recoverable.</p>
<p>The ViewModel is meant to handle state while in-memory, and the owning Fragment/Activity is supposed to save relevant parts of this state when being killed. <strong>You need to use both of these together to correctly handle state restoration</strong>.</p>
<h3 id="problems-with-onsaveinstancestate">Problems with onSaveInstanceState<a class="headerlink" href="#problems-with-onsaveinstancestate" title="Permanent link">&para;</a></h3>
<p>This setup works okay-ish when your application is small, or when the state is not complex. The biggest problem with this setup is that it also makes the Activity or Fragment responsible for managing state. Besides, it is difficult to implement this method correctly, and the user must also remember to extract the saved state from the <code>savedInstanceState</code> bundle.</p>
<h3 id="vectors-solution">Vector's solution<a class="headerlink" href="#vectors-solution" title="Permanent link">&para;</a></h3>
<p>The <a href="https://developer.android.com/topic/libraries/architecture/viewmodel-savedstate">AndroidX ViewModel-SavedState</a> library helps with this problem. Vector builds on this library and provides a <code>SavedStateVectorViewModel</code>, which uses the <code>SavedStateHandle</code> object to help with state persistence.</p>
<div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">NotesListViewModel</span> <span class="n">@AssistedInject</span> <span class="k">constructor</span><span class="p">(</span>
  <span class="n">@Assisted</span> <span class="n">initialState</span><span class="p">:</span> <span class="n">NotesListState</span><span class="p">,</span>
  <span class="n">@Assisted</span> <span class="n">handle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">,</span>
  <span class="k">private</span> <span class="k">val</span> <span class="py">notesUse</span><span class="p">:</span> <span class="n">GetNotesUseCase</span>
<span class="p">):</span> <span class="n">SavedStateVectorViewModel</span><span class="p">(</span><span class="n">intitialState</span><span class="p">,</span> <span class="n">savedStatehandle</span> <span class="p">=</span> <span class="n">handle</span><span class="p">)</span>
</pre></div>


<p>The <code>SavedStateVectorVieWModel</code> has additional methods to help with state persistence: <code>setStateAndPersist</code> and <code>persistState</code>.
To use them, we need to make sure that our state class implements the <code>Parcelable</code> interface. We can use the <code>@Parcelize</code> annotation from <a href="https://kotlinlang.org/docs/tutorials/android-plugin.html">Kotlin-Android-Extensions</a> to automatically generate the implementation for us.</p>
<div class="codehilite"><pre><span></span><span class="n">@Parcelize</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">NotesListState</span><span class="p">(...):</span> <span class="n">Parcelable</span>
</pre></div>


<h4 id="persisting-state">Persisting state<a class="headerlink" href="#persisting-state" title="Permanent link">&para;</a></h4>
<p>To persist state, we can simply replace the usage of <code>setState</code> in our ViewModel with <code>setStateAndPersist</code> to make sure that we save the latest state whenever it is modified. This way, whenever the application process is killed we would have already persisted the latest state.</p>
<p>The <code>setStateAndPersist</code> method first invokes the state reducer, and then calls <code>persistState()</code>. The default implementation of <code>persistState()</code> simply takes the state object, and saves it to the <code>SavedStateHandle</code> using the key <code>KEY_SAVED_SAVED</code> defined in the companion object of <code>SavedStateVectorViewModel</code>.</p>
<p>To customize this behaviour, you can override the <code>persistState()</code> method and provide your own implementation.</p>
<h4 id="restoring-state">Restoring state<a class="headerlink" href="#restoring-state" title="Permanent link">&para;</a></h4>
<p>To restore the state, the <code>initialState</code> method of <code>VectorViewModelFactory</code> must be implemented in the ViewModel's companion object:</p>
<div class="codehilite"><pre><span></span><span class="k">fun</span> <span class="nf">initialState</span><span class="p">(</span><span class="n">handle</span><span class="p">:</span> <span class="n">SavedStateHandle</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">ViewModelOwner</span><span class="p">):</span> <span class="n">NotesListState</span><span class="p">?</span> <span class="p">{</span>
  <span class="k">val</span> <span class="py">persistedState</span> <span class="p">=</span> <span class="n">handle</span><span class="p">[</span><span class="n">KEY_SAVED_STATE</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">persistedState</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">persistedState</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../usage/" title="Simple" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Simple
              </span>
            </div>
          </a>
        
        
          <a href="../vector-state/" title="Vector State" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Vector State
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/haroldadmin" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/haroldadmin" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://reddit.com/u/theharolddev" class="md-footer-social__link fa fa-reddit"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.c648116f.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
    
  </body>
</html>